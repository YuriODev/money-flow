name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'

jobs:
  # ============================================================================
  # Gitleaks Secret Scanning
  # ============================================================================
  gitleaks:
    name: Scan for Secrets (Gitleaks)
    runs-on: ubuntu-latest
    # Continue on error - Gitleaks requires paid license for org repos
    continue-on-error: true
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ============================================================================
  # TruffleHog Secret Scanning (Deep History)
  # ============================================================================
  trufflehog:
    name: Scan for Secrets (TruffleHog)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog Scan (Push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified

      - name: TruffleHog Scan (Scheduled)
        if: github.event_name == 'schedule'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --since-commit HEAD~100

  # ============================================================================
  # Detect-Secrets Baseline Check
  # ============================================================================
  detect-secrets:
    name: Detect Secrets Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          detect-secrets scan --all-files \
            --exclude-files 'package-lock\.json' \
            --exclude-files '\.secrets\.baseline' \
            --exclude-files 'frontend/node_modules/.*' \
            --exclude-files '\.next/.*' \
            > .secrets.scan.json || true

      - name: Check for new secrets
        run: |
          if [ -f .secrets.baseline ]; then
            detect-secrets audit --report .secrets.baseline || echo "Audit complete"
          else
            echo "No baseline file found. Consider creating one with: detect-secrets scan > .secrets.baseline"
          fi

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results
          path: .secrets.scan.json
          retention-days: 30

  # ============================================================================
  # Notify on Secret Scanning Results
  # ============================================================================
  notify-secrets:
    name: Notify Secret Scan Results
    runs-on: ubuntu-latest
    needs: [gitleaks, trufflehog, detect-secrets]
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Notify Secret Scan Success (Telegram - Monitoring Topic)
        # Only check TruffleHog and Detect-Secrets (Gitleaks requires paid license for orgs)
        if: needs.trufflehog.result == 'success' && needs.detect-secrets.result == 'success'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_MONITORING: ${{ secrets.TELEGRAM_THREAD_MONITORING }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          # Gitleaks status - show as skipped if no license configured
          GITLEAKS_STATUS="${{ needs.gitleaks.result == 'success' && '‚úì' || '‚ö†Ô∏è Skipped (no license)' }}"

          if [ -n "$TELEGRAM_THREAD_MONITORING" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_MONITORING}, \"parse_mode\": \"HTML\", \"text\": \"üîí <b>Money Flow - Secret Scan Passed</b>\n\nüîç <b>Gitleaks:</b> ${GITLEAKS_STATUS}\nüîç <b>TruffleHog:</b> ‚úì No secrets found\nüîç <b>Detect-Secrets:</b> ‚úì Baseline clean\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View Scan Results</a>\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"üîí <b>Money Flow - Secret Scan Passed</b>\n\nüîç <b>Gitleaks:</b> ${GITLEAKS_STATUS}\nüîç <b>TruffleHog:</b> ‚úì No secrets found\nüîç <b>Detect-Secrets:</b> ‚úì Baseline clean\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View Scan Results</a>\"}"
          fi

      - name: Notify Secret Scan Failure (Telegram - Errors Topic)
        # Only alert on TruffleHog or Detect-Secrets failure (real secret detection)
        if: needs.trufflehog.result == 'failure' || needs.detect-secrets.result == 'failure'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ERRORS: ${{ secrets.TELEGRAM_THREAD_ERRORS }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          TRUFFLEHOG_STATUS="${{ needs.trufflehog.result == 'success' && '‚úì' || '‚úó ALERT' }}"
          DETECT_STATUS="${{ needs.detect-secrets.result == 'success' && '‚úì' || '‚úó ALERT' }}"

          if [ -n "$TELEGRAM_THREAD_ERRORS" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_ERRORS}, \"parse_mode\": \"HTML\", \"text\": \"üö® <b>Money Flow - SECRET DETECTED!</b>\n\nüîç <b>TruffleHog:</b> ${TRUFFLEHOG_STATUS}\nüîç <b>Detect-Secrets:</b> ${DETECT_STATUS}\n\n‚ö†Ô∏è <b>Action Required:</b> Review and rotate any exposed credentials immediately!\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View Details</a>\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"üö® <b>Money Flow - SECRET DETECTED!</b>\n\nüîç <b>TruffleHog:</b> ${TRUFFLEHOG_STATUS}\nüîç <b>Detect-Secrets:</b> ${DETECT_STATUS}\n\n‚ö†Ô∏è <b>Action Required:</b> Review and rotate any exposed credentials immediately!\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View Details</a>\"}"
          fi
