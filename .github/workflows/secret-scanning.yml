name: Secret Scanning

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run daily at 02:00 UTC
    - cron: '0 2 * * *'

jobs:
  # ============================================================================
  # Gitleaks Secret Scanning
  # ============================================================================
  gitleaks:
    name: Scan for Secrets (Gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}

  # ============================================================================
  # TruffleHog Secret Scanning (Deep History)
  # ============================================================================
  trufflehog:
    name: Scan for Secrets (TruffleHog)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Scan (PR)
        if: github.event_name == 'pull_request'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.pull_request.base.sha }}
          head: ${{ github.event.pull_request.head.sha }}
          extra_args: --only-verified

      - name: TruffleHog Scan (Push)
        if: github.event_name == 'push'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.before }}
          head: ${{ github.event.after }}
          extra_args: --only-verified

      - name: TruffleHog Scan (Scheduled)
        if: github.event_name == 'schedule'
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --only-verified --since-commit HEAD~100

  # ============================================================================
  # Detect-Secrets Baseline Check
  # ============================================================================
  detect-secrets:
    name: Detect Secrets Baseline
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install detect-secrets
        run: pip install detect-secrets

      - name: Run detect-secrets scan
        run: |
          detect-secrets scan --all-files \
            --exclude-files 'package-lock\.json' \
            --exclude-files '\.secrets\.baseline' \
            --exclude-files 'frontend/node_modules/.*' \
            --exclude-files '\.next/.*' \
            > .secrets.scan.json || true

      - name: Check for new secrets
        run: |
          if [ -f .secrets.baseline ]; then
            detect-secrets audit --report .secrets.baseline || echo "Audit complete"
          else
            echo "No baseline file found. Consider creating one with: detect-secrets scan > .secrets.baseline"
          fi

      - name: Upload Scan Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: secret-scan-results
          path: .secrets.scan.json
          retention-days: 30
