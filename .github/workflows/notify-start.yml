name: Notify CI Started

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  notify:
    name: Send Start Notification
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Send Telegram Notification (CI Builds Topic)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_CI: ${{ secrets.TELEGRAM_THREAD_CI }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          # Get first line of commit message
          COMMIT_MSG=$(echo '${{ github.event.head_commit.message }}' | head -1)

          # Build message with newlines
          MESSAGE="üöÄ <b>Money Flow - CI Started</b>

üîó <b>Commit:</b> <a href=\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\">${{ github.sha }}</a>
üë§ <b>Author:</b> ${{ github.actor }}
üìù <b>Message:</b> ${COMMIT_MSG}

üìã <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Watch CI run</a>"

          # Build JSON payload
          if [ -n "$TELEGRAM_THREAD_CI" ]; then
            JSON_PAYLOAD=$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              --arg thread_id "$TELEGRAM_THREAD_CI" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML", message_thread_id: ($thread_id | tonumber)}')
          else
            JSON_PAYLOAD=$(jq -n \
              --arg chat_id "$TELEGRAM_CHAT_ID" \
              --arg text "$MESSAGE" \
              '{chat_id: $chat_id, text: $text, parse_mode: "HTML"}')
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"
