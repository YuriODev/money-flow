name: Notify CI Started

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  notify:
    name: Send Start Notification
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Send Telegram Notification (CI Builds Topic)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_CI: ${{ secrets.TELEGRAM_THREAD_CI }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi
          MESSAGE="üöÄ <b>Money Flow - CI Started</b>%0A%0A"
          MESSAGE+="üîó <b>Commit:</b> <a href=\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\">${{ github.sha }}</a>%0A"
          MESSAGE+="üë§ <b>Author:</b> ${{ github.actor }}%0A"
          MESSAGE+="üìù <b>Message:</b> $(echo '${{ github.event.head_commit.message }}' | head -1)%0A%0A"
          MESSAGE+="üìã <a href=\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\">Watch CI run</a>"

          # Build request with optional topic thread
          CURL_DATA="-d chat_id=${TELEGRAM_CHAT_ID} -d parse_mode=HTML -d text=${MESSAGE}"
          if [ -n "$TELEGRAM_THREAD_CI" ]; then
            CURL_DATA="$CURL_DATA -d message_thread_id=${TELEGRAM_THREAD_CI}"
          fi

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" $CURL_DATA
