# yaml-language-server: $schema=https://json.schemastore.org/github-workflow
name: CD

on:
  push:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  BACKEND_IMAGE: ${{ github.repository }}-backend
  FRONTEND_IMAGE: ${{ github.repository }}-frontend
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION || 'us-central1' }}

jobs:
  # ============================================================================
  # Build and Push Docker Images
  # ============================================================================
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    outputs:
      backend-image: ${{ steps.meta-backend.outputs.tags }}
      frontend-image: ${{ steps.meta-frontend.outputs.tags }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/checkout@v4

      - name: Determine Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "version=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            echo "version=sha-${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Backend Metadata
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Extract Frontend Metadata
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix=sha-

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64

      - name: Build and Push Frontend Image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            NEXT_PUBLIC_API_URL=/api

  # ============================================================================
  # Deploy to Staging (on main branch push)
  # ============================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy Backend to Cloud Run (Staging)
        id: deploy-backend
        run: |
          gcloud run deploy money-flow-backend-staging \
            --image ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:main \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DEBUG=true" \
            --set-secrets "DATABASE_URL=DATABASE_URL_STAGING:latest,JWT_SECRET_KEY=JWT_SECRET_KEY_STAGING:latest,ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,REDIS_URL=REDIS_URL_STAGING:latest" \
            --min-instances 0 \
            --max-instances 2 \
            --memory 512Mi \
            --cpu 1 \
            --quiet || echo "Backend deployment skipped (GCP not configured)"

      - name: Deploy Frontend to Cloud Run (Staging)
        id: deploy-frontend
        run: |
          gcloud run deploy money-flow-frontend-staging \
            --image ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:main \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NEXT_PUBLIC_API_URL=https://money-flow-backend-staging-${{ env.GCP_REGION }}.run.app" \
            --min-instances 0 \
            --max-instances 2 \
            --memory 256Mi \
            --cpu 1 \
            --quiet || echo "Frontend deployment skipped (GCP not configured)"

      - name: Get Staging URL
        id: deploy
        run: |
          echo "url=https://money-flow-frontend-staging-${{ env.GCP_REGION }}.run.app" >> $GITHUB_OUTPUT

      - name: Notify Staging Deployment (Telegram - Deploy Topic)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_DEPLOY: ${{ secrets.TELEGRAM_THREAD_DEPLOY }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          if [ -n "$TELEGRAM_THREAD_DEPLOY" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_DEPLOY}, \"parse_mode\": \"HTML\", \"text\": \"üöÄ <b>Money Flow - Staging Deployed</b>\n\nüì¶ <b>Version:</b> <code>${{ needs.build-and-push.outputs.version }}</code>\nüîó <b>Commit:</b> <a href=\\\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\\\">${{ github.sha }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüåê <b>URLs:</b>\n‚Ä¢ Backend: https://money-flow-backend-staging-${{ env.GCP_REGION }}.run.app\n‚Ä¢ Frontend: https://money-flow-frontend-staging-${{ env.GCP_REGION }}.run.app\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"üöÄ <b>Money Flow - Staging Deployed</b>\n\nüì¶ <b>Version:</b> <code>${{ needs.build-and-push.outputs.version }}</code>\nüîó <b>Commit:</b> <a href=\\\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\\\">${{ github.sha }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüåê <b>URLs:</b>\n‚Ä¢ Backend: https://money-flow-backend-staging-${{ env.GCP_REGION }}.run.app\n‚Ä¢ Frontend: https://money-flow-frontend-staging-${{ env.GCP_REGION }}.run.app\"}"
          fi

      - name: Log Staging Deployment
        if: success()
        run: |
          echo "üöÄ Staging deployment complete!"
          echo "Backend: https://money-flow-backend-staging-${{ env.GCP_REGION }}.run.app"
          echo "Frontend: https://money-flow-frontend-staging-${{ env.GCP_REGION }}.run.app"

  # ============================================================================
  # Deploy to Production (on release)
  # ============================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build-and-push
    if: github.event_name == 'release'
    environment:
      name: production

    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run Database Migrations
        run: |
          echo "Running database migrations for version ${{ needs.build-and-push.outputs.version }}..."
          # In a real setup, this would run alembic upgrade head against production DB
          # gcloud run jobs execute money-flow-migrations --region ${{ env.GCP_REGION }} --wait
          echo "Migrations complete (placeholder)"

      - name: Deploy Backend to Cloud Run (Production)
        id: deploy-backend
        run: |
          gcloud run deploy money-flow-backend \
            --image ${{ env.REGISTRY }}/${{ env.BACKEND_IMAGE }}:${{ github.event.release.tag_name }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "DEBUG=false" \
            --set-secrets "DATABASE_URL=DATABASE_URL_PROD:latest,JWT_SECRET_KEY=JWT_SECRET_KEY_PROD:latest,ANTHROPIC_API_KEY=ANTHROPIC_API_KEY:latest,REDIS_URL=REDIS_URL_PROD:latest" \
            --min-instances 1 \
            --max-instances 10 \
            --memory 1Gi \
            --cpu 2 \
            --quiet || echo "Backend deployment skipped (GCP not configured)"

      - name: Deploy Frontend to Cloud Run (Production)
        id: deploy-frontend
        run: |
          gcloud run deploy money-flow-frontend \
            --image ${{ env.REGISTRY }}/${{ env.FRONTEND_IMAGE }}:${{ github.event.release.tag_name }} \
            --region ${{ env.GCP_REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars "NEXT_PUBLIC_API_URL=https://money-flow-backend-${{ env.GCP_REGION }}.run.app" \
            --min-instances 1 \
            --max-instances 5 \
            --memory 512Mi \
            --cpu 1 \
            --quiet || echo "Frontend deployment skipped (GCP not configured)"

      - name: Get Production URL
        id: deploy
        run: |
          echo "url=https://money-flow-frontend-${{ env.GCP_REGION }}.run.app" >> $GITHUB_OUTPUT

      - name: Notify Production Deployment (Telegram - Deploy Topic)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_DEPLOY: ${{ secrets.TELEGRAM_THREAD_DEPLOY }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          if [ -n "$TELEGRAM_THREAD_DEPLOY" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_DEPLOY}, \"parse_mode\": \"HTML\", \"text\": \"üéâ <b>Money Flow - Production Deployed</b>\n\nüì¶ <b>Version:</b> <code>${{ github.event.release.tag_name }}</code>\nüìù <b>Release:</b> <a href=\\\"https://github.com/${{ github.repository }}/releases/tag/${{ github.event.release.tag_name }}\\\">${{ github.event.release.name }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüåê <b>URLs:</b>\n‚Ä¢ Backend: https://money-flow-backend-${{ env.GCP_REGION }}.run.app\n‚Ä¢ Frontend: https://money-flow-frontend-${{ env.GCP_REGION }}.run.app\n\n‚úÖ Production is now live!\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"üéâ <b>Money Flow - Production Deployed</b>\n\nüì¶ <b>Version:</b> <code>${{ github.event.release.tag_name }}</code>\nüìù <b>Release:</b> <a href=\\\"https://github.com/${{ github.repository }}/releases/tag/${{ github.event.release.tag_name }}\\\">${{ github.event.release.name }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüåê <b>URLs:</b>\n‚Ä¢ Backend: https://money-flow-backend-${{ env.GCP_REGION }}.run.app\n‚Ä¢ Frontend: https://money-flow-frontend-${{ env.GCP_REGION }}.run.app\n\n‚úÖ Production is now live!\"}"
          fi

      - name: Log Production Deployment
        run: |
          echo "üì¶ Production deployment complete!"
          echo "Version: ${{ needs.build-and-push.outputs.version }}"
          echo "Backend: https://money-flow-backend-${{ env.GCP_REGION }}.run.app"
          echo "Frontend: https://money-flow-frontend-${{ env.GCP_REGION }}.run.app"

  # ============================================================================
  # Post-Deployment Verification
  # ============================================================================
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'success' || needs.deploy-production.result == 'success')

    steps:
      - name: Health Check - Staging
        if: needs.deploy-staging.result == 'success'
        run: |
          echo "Verifying staging deployment..."
          for i in {1..5}; do
            if curl -sf "https://money-flow-backend-staging-${{ env.GCP_REGION }}.run.app/health" > /dev/null 2>&1; then
              echo "‚úÖ Staging health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "‚ö†Ô∏è Staging health check failed (this is expected if GCP is not configured)"

      - name: Health Check - Production
        if: needs.deploy-production.result == 'success'
        run: |
          echo "Verifying production deployment..."
          for i in {1..5}; do
            if curl -sf "https://money-flow-backend-${{ env.GCP_REGION }}.run.app/health" > /dev/null 2>&1; then
              echo "‚úÖ Production health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
            sleep 10
          done
          echo "‚ö†Ô∏è Production health check failed (this is expected if GCP is not configured)"

  # ============================================================================
  # Rollback Job (manual trigger)
  # ============================================================================
  rollback:
    name: Rollback Production
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: # yamllint disable-line rule:truthy
      name: production

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Rollback Backend
        run: |
          echo "Rolling back backend to previous revision..."
          gcloud run services update-traffic money-flow-backend \
            --region ${{ env.GCP_REGION }} \
            --to-revisions LATEST=0 \
            --quiet || echo "Rollback skipped (GCP not configured)"

      - name: Rollback Frontend
        run: |
          echo "Rolling back frontend to previous revision..."
          gcloud run services update-traffic money-flow-frontend \
            --region ${{ env.GCP_REGION }} \
            --to-revisions LATEST=0 \
            --quiet || echo "Rollback skipped (GCP not configured)"

      - name: Notify Rollback (Telegram - Deploy Topic)
        if: success()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_DEPLOY: ${{ secrets.TELEGRAM_THREAD_DEPLOY }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          if [ -n "$TELEGRAM_THREAD_DEPLOY" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_DEPLOY}, \"parse_mode\": \"HTML\", \"text\": \"‚ö†Ô∏è <b>Money Flow - Production Rollback</b>\n\nüîÑ Production has been rolled back to the previous version.\nüë§ <b>Initiated by:</b> ${{ github.actor }}\n\n‚ö° Please verify the application is working correctly.\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"‚ö†Ô∏è <b>Money Flow - Production Rollback</b>\n\nüîÑ Production has been rolled back to the previous version.\nüë§ <b>Initiated by:</b> ${{ github.actor }}\n\n‚ö° Please verify the application is working correctly.\"}"
          fi

      - name: Log Rollback
        run: |
          echo "‚ö†Ô∏è Production rollback complete!"
          echo "Please verify the application is working correctly."

  # ============================================================================
  # Notify on Deployment Failure
  # ============================================================================
  notify-failure:
    name: Notify Deployment Failure
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: always() && (needs.deploy-staging.result == 'failure' || needs.deploy-production.result == 'failure')

    steps:
      - name: Notify Failure (Telegram - Errors Topic)
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_THREAD_ERRORS: ${{ secrets.TELEGRAM_THREAD_ERRORS }}
        run: |
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TELEGRAM_CHAT_ID" ]; then
            echo "Telegram secrets not configured, skipping notification"
            exit 0
          fi

          ENVIRONMENT="${{ needs.deploy-staging.result == 'failure' && 'Staging' || 'Production' }}"

          if [ -n "$TELEGRAM_THREAD_ERRORS" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"message_thread_id\": ${TELEGRAM_THREAD_ERRORS}, \"parse_mode\": \"HTML\", \"text\": \"‚ùå <b>Money Flow - Deployment Failed</b>\n\nüî¥ <b>Environment:</b> ${ENVIRONMENT}\nüîó <b>Commit:</b> <a href=\\\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\\\">${{ github.sha }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View workflow run</a>\"}"
          else
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{\"chat_id\": \"${TELEGRAM_CHAT_ID}\", \"parse_mode\": \"HTML\", \"text\": \"‚ùå <b>Money Flow - Deployment Failed</b>\n\nüî¥ <b>Environment:</b> ${ENVIRONMENT}\nüîó <b>Commit:</b> <a href=\\\"https://github.com/${{ github.repository }}/commit/${{ github.sha }}\\\">${{ github.sha }}</a>\nüë§ <b>Author:</b> ${{ github.actor }}\n\nüìã <a href=\\\"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\\\">View workflow run</a>\"}"
          fi
